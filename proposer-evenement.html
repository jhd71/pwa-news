<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Proposer un √©v√©nement - Actu & M√©dia Montceau</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-elevated: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-muted: rgba(255, 255, 255, 0.5);
            --border-color: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-elevated: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .page-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .back-btn:hover { background: var(--primary); border-color: var(--primary); color: white; }
        .page-title h1 { font-size: 1.2rem; font-weight: 700; }
        .page-title p { font-size: 0.8rem; color: var(--text-muted); }
        
        .form-container { padding: 1rem; max-width: 600px; margin: 0 auto; }
        
        .form-intro {
            text-align: center;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .form-intro-icon { font-size: 3rem; margin-bottom: 0.5rem; }
        .form-intro-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }
        .form-intro-text { font-size: 0.9rem; color: var(--text-secondary); }
        
        .event-form { display: flex; flex-direction: column; gap: 1.25rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        
        .form-label {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .form-label .material-icons { font-size: 1.1rem; color: var(--primary-light); }
        .form-label .required { color: #ef4444; }
        
        .form-input, .form-select, .form-textarea {
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-hint { font-size: 0.8rem; color: var(--text-muted); }
        
        [data-theme="light"] .form-input,
        [data-theme="light"] .form-select,
        [data-theme="light"] .form-textarea { background: white; border-color: #e2e8f0; }
        
        /* Cat√©gories */
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
        
        .category-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            padding: 0.75rem;
            background: var(--bg-elevated);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-option:hover { border-color: var(--primary-light); }
        .category-option.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.15); }
        .category-option input { display: none; }
        .category-option-icon { font-size: 1.5rem; }
        .category-option-name { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); }
        .category-option.selected .category-option-name { color: var(--primary-light); font-weight: 600; }
        
        [data-theme="light"] .category-option { background: white; }
        [data-theme="light"] .category-option.selected { background: rgba(99, 102, 241, 0.1); }
        
        /* R√©currence */
        .recurrence-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .recurrence-toggle:hover { border-color: var(--primary-light); }
        .recurrence-toggle.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .recurrence-toggle input { display: none; }
        
        .recurrence-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .recurrence-toggle.active .recurrence-checkbox { background: var(--primary); border-color: var(--primary); }
        .recurrence-checkbox .material-icons { font-size: 1rem; color: white; opacity: 0; }
        .recurrence-toggle.active .recurrence-checkbox .material-icons { opacity: 1; }
        .recurrence-text { flex: 1; }
        .recurrence-text strong { display: block; font-size: 0.9rem; }
        .recurrence-text small { font-size: 0.8rem; color: var(--text-muted); }
        
        .recurrence-options {
            display: none;
            margin-top: 0.75rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }
        
        .recurrence-options.show { display: block; }
        .recurrence-days { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        
        /* JOURS - CSS CORRIG√â */
        .recurrence-day {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--bg-elevated);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .recurrence-day:hover { 
            border-color: var(--primary-light); 
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* √âTAT S√âLECTIONN√â - TR√àS VISIBLE */
        .recurrence-day.selected { 
            background: var(--primary) !important; 
            border-color: var(--primary) !important; 
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .recurrence-day input { display: none; }
        
        [data-theme="light"] .recurrence-day { background: white; }
        [data-theme="light"] .recurrence-day.selected { 
            background: var(--primary) !important; 
            color: white !important; 
        }
        
        /* Image upload */
        .image-upload {
            position: relative;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-upload:hover { border-color: var(--primary-light); background: rgba(99, 102, 241, 0.05); }
        .image-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .image-upload-icon { font-size: 2.5rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .image-upload-text { font-size: 0.9rem; color: var(--text-secondary); }
        .image-upload-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .image-preview { display: none; position: relative; margin-top: 1rem; }
        .image-preview.show { display: block; }
        .image-preview img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; }
        
        .image-preview-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview-remove:hover { background: #ef4444; }
        
        .submit-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .submit-btn .material-icons.spinning { animation: spin 1s linear infinite; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 2rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            margin-top: 1rem;
        }
        
        .success-message.show { display: block; }
        .success-message-icon { font-size: 3rem; margin-bottom: 0.5rem; }
        .success-message-title { font-size: 1.2rem; font-weight: 600; color: #22c55e; margin-bottom: 0.5rem; }
        .success-message-text { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1.5rem; }
        .success-buttons { display: flex; flex-direction: column; gap: 0.75rem; }
        
        .success-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .success-btn.primary { background: var(--primary); color: white; }
        .success-btn.primary:hover { background: var(--primary-light); }
        .success-btn.secondary { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
        .success-btn.secondary:hover { background: var(--bg-elevated); }
        
        @media (max-width: 480px) {
            .category-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
            .recurrence-day { width: 42px; height: 42px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <a href="agenda.html" class="back-btn">
            <span class="material-icons">arrow_back</span>
        </a>
        <div class="page-title">
            <h1>üìÖ Proposer un √©v√©nement</h1>
            <p>Partagez avec la communaut√©</p>
        </div>
    </header>
    
    <div class="form-container">
        <div class="form-intro">
            <div class="form-intro-icon">üéâ</div>
            <div class="form-intro-title">Vous organisez un √©v√©nement ?</div>
            <div class="form-intro-text">
                Partagez-le avec les habitants de Montceau et environs !<br>
                Votre proposition sera valid√©e avant publication.
            </div>
        </div>
        
        <form class="event-form" id="eventForm">
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">title</span>
                    Titre de l'√©v√©nement <span class="required">*</span>
                </label>
                <input type="text" class="form-input" id="eventTitle" placeholder="Ex: March√© de No√´l, Concert Jazz..." maxlength="200" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">category</span>
                    Cat√©gorie <span class="required">*</span>
                </label>
                <div class="category-grid" id="categoryGrid">
                    <label class="category-option">
                        <input type="radio" name="category" value="fete">
                        <span class="category-option-icon">üéâ</span>
                        <span class="category-option-name">F√™te</span>
                    </label>
                    <label class="category-option">
                        <input type="radio" name="category" value="autre">
                        <span class="category-option-icon">üìå</span>
                        <span class="category-option-name">Autre</span>
                    </label>
                </div>
                    <label class="category-option">
                        <input type="radio" name="category" value="culture">
                        <span class="category-option-icon">üé≠</span>
                        <span class="category-option-name">Culture</span>
                    </label>
                    <label class="category-option">
                        <input type="radio" name="category" value="marche">
                        <span class="category-option-icon">üõí</span>
                        <span class="category-option-name">March√©</span>
                    </label>
                    <label class="category-option">
                        <input type="radio" name="category" value="brocante">
                        <span class="category-option-icon">üè∑Ô∏è</span>
                        <span class="category-option-name">Brocante</span>
                    </label>
                    <label class="category-option">
                        <input type="radio" name="category" value="concert">
                        <span class="category-option-icon">üéµ</span>
                        <span class="category-option-name">Concert</span>
                    </label>
                    <label class="category-option">
                        <input type="radio" name="category" value="fete">
                        <span class="category-option-icon">üéâ</span>
                        <span class="category-option-name">F√™te</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="recurrence-toggle" id="recurrenceToggle">
                    <input type="checkbox" id="isRecurrent">
                    <span class="recurrence-checkbox">
                        <span class="material-icons">check</span>
                    </span>
                    <span class="recurrence-text">
                        <strong>√âv√©nement r√©current</strong>
                        <small>Se r√©p√®te chaque semaine (ex: march√© du jeudi)</small>
                    </span>
                </label>
                
                <div class="recurrence-options" id="recurrenceOptions">
                    <label class="form-label" style="margin-bottom: 0.5rem;">
                        <span class="material-icons">repeat</span>
                        Jours de la semaine
                    </label>
                    <div class="recurrence-days" id="recurrenceDays">
                        <div class="recurrence-day" data-day="1">Lun</div>
                        <div class="recurrence-day" data-day="2">Mar</div>
                        <div class="recurrence-day" data-day="3">Mer</div>
                        <div class="recurrence-day" data-day="4">Jeu</div>
                        <div class="recurrence-day" data-day="5">Ven</div>
                        <div class="recurrence-day" data-day="6">Sam</div>
                        <div class="recurrence-day" data-day="0">Dim</div>
                    </div>
                    <p class="form-hint" style="margin-top: 0.75rem;">
                        L'√©v√©nement sera affich√© automatiquement chaque semaine aux jours s√©lectionn√©s.
                    </p>
                </div>
            </div>
            
            <div id="singleDateFields">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="material-icons">event</span>
                            Date <span class="required">*</span>
                        </label>
                        <input type="date" class="form-input" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span class="material-icons">schedule</span>
                            Heure de d√©but
                        </label>
                        <input type="time" class="form-input" id="eventTime">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="material-icons">schedule</span>
                        Heure de fin
                    </label>
                    <input type="time" class="form-input" id="eventEndTime">
                </div>
            </div>
            
            <div id="recurringTimeFields" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="material-icons">schedule</span>
                            Heure de d√©but
                        </label>
                        <input type="time" class="form-input" id="eventTimeRecurring">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span class="material-icons">schedule</span>
                            Heure de fin
                        </label>
                        <input type="time" class="form-input" id="eventEndTimeRecurring">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">place</span>
                    Lieu <span class="required">*</span>
                </label>
                <input type="text" class="form-input" id="eventLocation" placeholder="Ex: Place de la Mairie, Salle des f√™tes..." maxlength="200" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">description</span>
                    Description
                </label>
                <textarea class="form-textarea" id="eventDescription" placeholder="D√©crivez votre √©v√©nement..." maxlength="1000"></textarea>
                <span class="form-hint">Max. 1000 caract√®res</span>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">link</span>
                    Lien (optionnel)
                </label>
                <input type="url" class="form-input" id="eventLink" placeholder="https://...">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">image</span>
                    Image (optionnel)
                </label>
                <div class="image-upload" id="imageUpload">
                    <input type="file" accept="image/*" id="eventImage">
                    <div class="image-upload-icon">üì∑</div>
                    <div class="image-upload-text">Cliquez ou glissez une image</div>
                    <div class="image-upload-hint">JPG, PNG ‚Ä¢ Max 5 Mo</div>
                </div>
                <div class="image-preview" id="imagePreview">
                    <img src="" alt="Aper√ßu" id="previewImg">
                    <button type="button" class="image-preview-remove" id="removeImage">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="material-icons">person</span>
                    Votre nom / organisation <span class="required">*</span>
                </label>
                <input type="text" class="form-input" id="eventAuthor" placeholder="Ex: Mairie de Montceau, Association..." maxlength="100" required>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn">
                <span class="material-icons">send</span>
                Proposer l'√©v√©nement
            </button>
        </form>
        
        <div class="success-message" id="successMessage">
            <div class="success-message-icon">‚úÖ</div>
            <div class="success-message-title">√âv√©nement propos√© !</div>
            <div class="success-message-text">Merci ! Votre √©v√©nement sera valid√© et publi√© prochainement.</div>
            <div class="success-buttons">
                <a href="agenda.html" class="success-btn primary">
                    <span class="material-icons">event</span>
                    Retour √† l'agenda
                </a>
                <a href="index.html" class="success-btn secondary">
                    <span class="material-icons">home</span>
                    Retour √† l'accueil
                </a>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ekjgfiyhkythqcnmhzea.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVramdmaXloa3l0aHFjbm1oemVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzYxNDIsImV4cCI6MjA1ODI1MjE0Mn0.V0j_drb6GiTojgwxC6ydjnyJDRRT9lUbSc1E7bFE2Z4';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let selectedImage = null;
        let selectedDays = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initCategorySelection();
            initRecurrence();
            initImageUpload();
            initForm();
            setMinDate();
        });
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }
        
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eventDate').setAttribute('min', today);
        }
        
        function initCategorySelection() {
            const options = document.querySelectorAll('.category-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    options.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        }
        
        function initRecurrence() {
            const toggle = document.getElementById('recurrenceToggle');
            const checkbox = document.getElementById('isRecurrent');
            const options = document.getElementById('recurrenceOptions');
            const singleDateFields = document.getElementById('singleDateFields');
            const recurringTimeFields = document.getElementById('recurringTimeFields');
            
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                checkbox.checked = !checkbox.checked;
                toggle.classList.toggle('active', checkbox.checked);
                options.classList.toggle('show', checkbox.checked);
                
                if (checkbox.checked) {
                    singleDateFields.style.display = 'none';
                    recurringTimeFields.style.display = 'block';
                } else {
                    singleDateFields.style.display = 'block';
                    recurringTimeFields.style.display = 'none';
                }
            });
            
            // Jours de la semaine - CLIC CORRIG√â
            const days = document.querySelectorAll('.recurrence-day');
            days.forEach(day => {
                day.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const dayValue = day.dataset.day;
                    
                    // Toggle la s√©lection
                    day.classList.toggle('selected');
                    
                    // Mettre √† jour le tableau des jours s√©lectionn√©s
                    if (day.classList.contains('selected')) {
                        if (!selectedDays.includes(dayValue)) {
                            selectedDays.push(dayValue);
                        }
                    } else {
                        selectedDays = selectedDays.filter(d => d !== dayValue);
                    }
                    
                    console.log('Jours s√©lectionn√©s:', selectedDays);
                });
            });
        }
        
        function initImageUpload() {
            const input = document.getElementById('eventImage');
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const removeBtn = document.getElementById('removeImage');
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image trop volumineuse (max 5 Mo)');
                        input.value = '';
                        return;
                    }
                    selectedImage = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                        preview.classList.add('show');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeBtn.addEventListener('click', () => {
                input.value = '';
                selectedImage = null;
                preview.classList.remove('show');
            });
        }
        
        function initForm() {
            const form = document.getElementById('eventForm');
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const category = document.querySelector('input[name="category"]:checked');
                if (!category) {
                    alert('Veuillez s√©lectionner une cat√©gorie');
                    return;
                }
                
                const isRecurrent = document.getElementById('isRecurrent').checked;
                
                if (isRecurrent) {
                    if (selectedDays.length === 0) {
                        alert('Veuillez s√©lectionner au moins un jour de la semaine');
                        return;
                    }
                } else {
                    if (!document.getElementById('eventDate').value) {
                        alert('Veuillez s√©lectionner une date');
                        return;
                    }
                }
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="material-icons spinning">sync</span> Envoi en cours...';
                
                try {
                    let imageUrl = null;
                    if (selectedImage) {
                        const fileName = `event_${Date.now()}_${selectedImage.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                        const { error: uploadError } = await supabaseClient.storage.from('event-images').upload(fileName, selectedImage);
                        if (!uploadError) {
                            const { data: urlData } = supabaseClient.storage.from('event-images').getPublicUrl(fileName);
                            imageUrl = urlData.publicUrl;
                        }
                    }
                    
                    const title = document.getElementById('eventTitle').value.trim();
                    const location = document.getElementById('eventLocation').value.trim();
                    const description = document.getElementById('eventDescription').value.trim() || null;
                    const link = document.getElementById('eventLink').value.trim() || null;
                    const author = document.getElementById('eventAuthor').value.trim();
                    
                    // Cr√©er UN SEUL √©v√©nement (r√©current ou non)
                    const eventData = {
                        title,
                        category: category.value,
                        location,
                        description,
                        link,
                        author,
                        image_url: imageUrl,
                        status: 'pending',
                        is_recurring: isRecurrent,
                        recurrence_days: isRecurrent ? selectedDays.sort().join(',') : null,
                        event_date: isRecurrent ? null : document.getElementById('eventDate').value,
                        event_time: isRecurrent 
                            ? (document.getElementById('eventTimeRecurring').value || null)
                            : (document.getElementById('eventTime').value || null),
                        end_time: isRecurrent 
                            ? (document.getElementById('eventEndTimeRecurring').value || null)
                            : (document.getElementById('eventEndTime').value || null)
                    };
                    
                    const { error } = await supabaseClient.from('events').insert([eventData]);
                    if (error) throw error;
                    
                    // Notification email
                    const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
                    const recurrenceInfo = isRecurrent 
                        ? `Tous les ${selectedDays.map(d => dayNames[parseInt(d)]).join(', ')}`
                        : document.getElementById('eventDate').value;
                    
                    try {
                        await fetch('/api/sendEmail', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'evenement',
                                title: title,
                                author: author,
                                content: `üìÖ ${recurrenceInfo}\nüìç ${location}\nüè∑Ô∏è ${category.value}\n\n${description || 'Pas de description'}`,
                                category: category.value,
                                isRecurrent: isRecurrent
                            })
                        });
                    } catch (e) {
                        console.log('Email notification non envoy√©e:', e);
                    }
                    
                    form.style.display = 'none';
                    successMessage.classList.add('show');
                    console.log('‚úÖ √âv√©nement propos√©');
                    
                } catch (error) {
                    console.error('‚ùå Erreur:', error);
                    alert('Erreur lors de l\'envoi. Veuillez r√©essayer.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span class="material-icons">send</span> Proposer l\'√©v√©nement';
                }
            });
        }
    </script>
</body>
</html>