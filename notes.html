<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Notes Vocales - Actu & M√©dia</title>
    <meta name="description" content="Dictaphone et notes vocales avec transcription automatique">
    <meta name="theme-color" content="#0a0a14">
    
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="manifest" href="/manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* ====== DARK THEME (d√©faut) ====== */
        :root, [data-theme="dark"] {
            --bg-body: #0a0a14;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-elevated: rgba(255, 255, 255, 0.08);
            --bg-hover: rgba(255, 255, 255, 0.12);
            --bg-header: rgba(10, 10, 20, 0.9);
            --bg-modal: #14141f;
            --border: rgba(255, 255, 255, 0.1);
            --text: #f0f0f5;
            --text-secondary: rgba(255, 255, 255, 0.65);
            --text-muted: rgba(255, 255, 255, 0.4);
            --primary: #6366f1;
            --primary-light: #818cf8;
            --accent-red: #ef4444;
            --accent-red-glow: rgba(239, 68, 68, 0.3);
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* ====== LIGHT THEME ====== */
        [data-theme="light"] {
            --bg-body: #f5f5f7;
            --bg-card: #ffffff;
            --bg-elevated: #f0f0f3;
            --bg-hover: #e8e8ec;
            --bg-header: rgba(245, 245, 247, 0.92);
            --bg-modal: #ffffff;
            --border: rgba(0, 0, 0, 0.1);
            --text: #1a1a2e;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --text-muted: rgba(0, 0, 0, 0.4);
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --accent-red: #dc2626;
            --accent-red-glow: rgba(220, 38, 38, 0.2);
            --accent-green: #059669;
            --accent-amber: #d97706;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-body);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* ====== HEADER ====== */
        .app-header {
            position: sticky; top: 0; z-index: 100;
            background: var(--bg-header);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .back-btn, .header-btn {
            width: 38px; height: 38px; border-radius: 12px;
            background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; text-decoration: none;
        }
        .header-btn { color: var(--text-secondary); }
        .back-btn:hover, .header-btn:hover { background: var(--bg-hover); color: var(--text); }
        .header-btn .material-icons { font-size: 20px; }
        .app-title { font-size: 1.15rem; font-weight: 700; }
        .app-title span { color: var(--primary-light); }
        .header-right { display: flex; gap: 6px; }

        [data-theme="light"] .back-btn,
        [data-theme="light"] .header-btn {
            box-shadow: var(--shadow);
        }

        /* ====== MAIN ====== */
        .app-main { max-width: 600px; margin: 0 auto; padding: 20px 16px 140px; }

        /* ====== MODE SELECTOR ====== */
        .mode-selector {
            display: flex; gap: 8px; margin-bottom: 16px;
        }
        .mode-btn {
            flex: 1; padding: 12px 8px; border-radius: 12px;
            background: var(--bg-card); border: 2px solid var(--border);
            color: var(--text-secondary); font-family: inherit; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; text-align: center;
            transition: all 0.2s; display: flex; flex-direction: column;
            align-items: center; gap: 4px;
        }
        .mode-btn .material-icons { font-size: 22px; }
        .mode-btn.active {
            border-color: var(--primary); color: var(--primary);
            background: rgba(99, 102, 241, 0.08);
        }
        .mode-btn .mode-desc {
            font-size: 0.65rem; font-weight: 400; opacity: 0.7;
        }

        [data-theme="light"] .mode-btn {
            box-shadow: var(--shadow);
        }

        /* ====== RECORDER ZONE ====== */
        .recorder-zone {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; margin-bottom: 24px;
            text-align: center; transition: all 0.3s;
        }
        .recorder-zone.recording { border-color: var(--accent-red); box-shadow: 0 0 30px var(--accent-red-glow); }

        [data-theme="light"] .recorder-zone { box-shadow: var(--shadow); }

        .audio-visualizer {
            height: 60px; display: flex; align-items: center; justify-content: center;
            gap: 3px; margin-bottom: 16px; opacity: 0.3; transition: opacity 0.3s;
        }
        .recorder-zone.recording .audio-visualizer { opacity: 1; }
        .viz-bar {
            width: 4px; height: 8px; background: var(--primary-light);
            border-radius: 4px; transition: height 0.08s ease;
        }
        .recorder-zone.recording .viz-bar { background: var(--accent-red); }

        .record-timer {
            font-size: 2rem; font-weight: 700; font-variant-numeric: tabular-nums;
            color: var(--text-muted); margin-bottom: 16px; transition: color 0.3s;
        }
        .recorder-zone.recording .record-timer { color: var(--accent-red); }

        .record-controls { display: flex; align-items: center; justify-content: center; }
        .record-btn {
            width: 72px; height: 72px; border-radius: 50%;
            border: 3px solid var(--accent-red); background: transparent;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .record-btn-inner {
            width: 44px; height: 44px; background: var(--accent-red);
            border-radius: 50%; transition: all 0.3s;
        }
        .record-btn:hover { transform: scale(1.08); box-shadow: 0 0 20px var(--accent-red-glow); }
        .recorder-zone.recording .record-btn-inner { width: 28px; height: 28px; border-radius: 6px; }

        .record-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 12px; }
        .recorder-zone.recording .record-label { color: var(--accent-red); }

        .speech-status { display: none; font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; }

        /* Live transcription */
        .live-transcription {
            display: none; margin-top: 20px; padding: 16px;
            background: var(--bg-elevated); border-radius: 12px;
            border: 1px solid var(--border); text-align: left;
        }
        .live-transcription.active { display: block; }
        .live-transcription-label {
            font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 1px; color: var(--accent-green); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .live-transcription-label .pulse {
            width: 8px; height: 8px; background: var(--accent-green);
            border-radius: 50%; animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .live-text { font-size: 0.95rem; line-height: 1.6; color: var(--text); min-height: 40px;
            max-height: 200px; overflow-y: auto; }
        .live-text .interim { color: var(--text-muted); font-style: italic; }

        /* Font size control */
        .font-size-bar {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 14px; margin-bottom: 16px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px;
        }
        .font-size-bar label { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; }
        .font-size-bar .small-a { font-size: 0.7rem; color: var(--text-muted); }
        .font-size-bar .big-a { font-size: 1.1rem; color: var(--text-muted); }
        .font-size-slider {
            flex: 1; -webkit-appearance: none; appearance: none;
            height: 4px; background: var(--border); border-radius: 4px; outline: none;
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px;
            background: var(--primary); border-radius: 50%; cursor: pointer;
        }
        [data-theme="light"] .font-size-bar { box-shadow: var(--shadow); }

        /* Warning */
        .browser-warning {
            display: none; padding: 14px 16px;
            background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius); margin-bottom: 16px;
            font-size: 0.85rem; color: var(--accent-amber); line-height: 1.5;
        }
        .browser-warning .material-icons { font-size: 18px; vertical-align: middle; margin-right: 6px; }

        /* ====== NOTES LIST ====== */
        .notes-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .notes-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .notes-count { font-size: 0.75rem; background: var(--bg-elevated); color: var(--text-muted); padding: 2px 10px; border-radius: 20px; }

        .notes-empty { text-align: center; padding: 48px 20px; color: var(--text-muted); }
        .notes-empty .material-icons { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
        .notes-empty p { font-size: 0.9rem; line-height: 1.6; }

        .note-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
            transition: all 0.2s; animation: fadeInUp 0.3s ease;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .note-card:hover { border-color: var(--primary); background: var(--bg-elevated); }

        [data-theme="light"] .note-card { box-shadow: var(--shadow); }

        .note-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
        .note-type-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; padding: 3px 10px; border-radius: 20px;
        }
        .note-type-badge.voice { background: rgba(239, 68, 68, 0.12); color: var(--accent-red); }
        .note-type-badge.text { background: rgba(99, 102, 241, 0.12); color: var(--primary-light); }
        .note-type-badge.dictation { background: rgba(16, 185, 129, 0.12); color: var(--accent-green); }
        .note-type-badge .material-icons { font-size: 14px; }
        .note-date { font-size: 0.75rem; color: var(--text-muted); }

        .note-content {
            font-size: var(--note-font-size, 0.9rem); line-height: 1.6; color: var(--text-secondary);
            margin-bottom: 12px; word-break: break-word; white-space: pre-wrap;
            max-height: 300px; overflow-y: auto;
        }

        .note-audio-player {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; background: var(--bg-elevated);
            border-radius: 12px; margin-bottom: 12px;
        }
        .note-play-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--primary); border: none; color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; transition: all 0.2s;
        }
        .note-play-btn:hover { background: var(--primary-light); transform: scale(1.1); }
        .note-play-btn .material-icons { font-size: 20px; }
        .note-audio-info { flex: 1; }
        .note-audio-duration { font-size: 0.75rem; color: var(--text-muted); font-variant-numeric: tabular-nums; }
        .note-audio-progress { width: 100%; height: 4px; background: var(--border); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .note-audio-progress-bar { height: 100%; width: 0%; background: var(--primary); border-radius: 4px; transition: width 0.2s; }

        .note-actions { display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap; }
        .note-action-btn {
            padding: 6px 10px; border-radius: 8px; background: transparent;
            border: 1px solid var(--border); color: var(--text-muted);
            font-size: 0.75rem; font-family: inherit; cursor: pointer;
            display: flex; align-items: center; gap: 4px; transition: all 0.2s;
        }
        .note-action-btn:hover { background: var(--bg-hover); color: var(--text); }
        .note-action-btn.delete:hover { background: rgba(239, 68, 68, 0.1); border-color: var(--accent-red); color: var(--accent-red); }
        .note-action-btn .material-icons { font-size: 16px; }

        /* ====== FAB ====== */
        .fab-text {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 16px;
            background: var(--primary); border: none; color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s; z-index: 90;
        }
        .fab-text:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(99, 102, 241, 0.5); }
        .fab-text .material-icons { font-size: 28px; }

        /* ====== MODALS ====== */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); z-index: 200;
            align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            width: 100%; max-width: 600px; background: var(--bg-modal);
            border-radius: 20px 20px 0 0; padding: 24px;
            max-height: 80vh; overflow-y: auto; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-elevated); border: none;
            color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .modal-textarea {
            width: 100%; min-height: 120px; padding: 16px;
            background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 12px; color: var(--text); font-family: inherit;
            font-size: 0.95rem; line-height: 1.6; resize: vertical; outline: none; margin-bottom: 16px;
        }
        .modal-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        .modal-textarea::placeholder { color: var(--text-muted); }
        .modal-save-btn {
            width: 100%; padding: 14px; background: var(--primary); border: none;
            border-radius: 12px; color: white; font-family: inherit;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;
        }
        .modal-save-btn:hover { background: var(--primary-light); }

        /* ====== TOAST ====== */
        .toast {
            position: fixed; bottom: 90px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px; background: var(--accent-green); color: white;
            border-radius: 12px; font-size: 0.85rem; font-weight: 600;
            z-index: 999; opacity: 0; transition: all 0.3s ease; white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ====== SEARCH ====== */
        .search-bar { display: none; margin-bottom: 16px; position: relative; }
        .search-bar.active { display: block; }
        .search-input {
            width: 100%; padding: 12px 16px 12px 44px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; color: var(--text); font-family: inherit; font-size: 0.9rem; outline: none;
        }
        .search-input:focus { border-color: var(--primary); }
        .search-bar .material-icons { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 20px; }

        @media (max-width: 400px) {
            .app-main { padding: 14px 12px 140px; }
            .recorder-zone { padding: 18px; }
            .record-btn { width: 64px; height: 64px; }
            .record-btn-inner { width: 38px; height: 38px; }
            .header-right { gap: 4px; }
            .header-btn { width: 34px; height: 34px; border-radius: 10px; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <a href="index.html" class="back-btn"><span class="material-icons">home</span></a>
            <div class="app-title">üéôÔ∏è Notes <span>Vocales</span> <small style="font-size:0.55rem;color:var(--text-muted);vertical-align:super;">v5</small></div>
        </div>
        <div class="header-right">
            <button class="header-btn" id="themeToggle" title="Changer le th√®me"><span class="material-icons">light_mode</span></button>
            <button class="header-btn" id="searchToggle" title="Rechercher"><span class="material-icons">search</span></button>
            <button class="header-btn" id="exportBtn" title="Exporter"><span class="material-icons">file_download</span></button>
            <button class="header-btn" id="importBtn" title="Importer"><span class="material-icons">file_upload</span></button>
            <button class="header-btn" id="deleteAllBtn" title="Tout supprimer"><span class="material-icons">delete_sweep</span></button>
            <input type="file" id="importFile" accept=".json" style="display:none">
        </div>
    </header>

    <main class="app-main">
        <div class="browser-warning" id="browserWarning">
            <span class="material-icons">warning</span>
            <strong>Mode Dict√©e indisponible :</strong> La transcription vocale n√©cessite Chrome, Edge ou Safari.
        </div>

        <!-- Mode selector -->
        <div class="mode-selector">
            <button class="mode-btn active" id="modeAudio" data-mode="audio">
                <span class="material-icons">mic</span>
                üéôÔ∏è Enregistrer
                <span class="mode-desc">Audio sans transcription</span>
            </button>
            <button class="mode-btn" id="modeDictation" data-mode="dictation">
                <span class="material-icons">record_voice_over</span>
                ‚úçÔ∏è Dicter
                <span class="mode-desc">Texte par la voix</span>
            </button>
        </div>

        <!-- Recorder -->
        <div class="recorder-zone" id="recorderZone">
            <div class="audio-visualizer" id="visualizer">
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
                <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
            </div>
            <div class="record-timer" id="recordTimer">00:00</div>
            <div class="record-controls">
                <button class="record-btn" id="recordBtn"><div class="record-btn-inner"></div></button>
            </div>
            <div class="record-label" id="recordLabel">Appuyez pour enregistrer</div>
            <div class="speech-status" id="speechStatus"></div>
            <div class="live-transcription" id="liveTranscription">
                <div class="live-transcription-label"><span class="pulse"></span> Transcription en cours</div>
                <div class="live-text" id="liveText"></div>
            </div>
        </div>

        <!-- Search -->
        <div class="search-bar" id="searchBar">
            <span class="material-icons">search</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Rechercher dans les notes...">
        </div>

        <div class="notes-header">
            <div class="notes-title">üìù Mes notes <span class="notes-count" id="notesCount">0</span></div>
        </div>

        <!-- Font size -->
        <div class="font-size-bar">
            <span class="small-a">A</span>
            <input type="range" class="font-size-slider" id="fontSizeSlider" min="12" max="22" value="14" step="1">
            <span class="big-a">A</span>
        </div>
        <div id="notesList"></div>
        <div class="notes-empty" id="notesEmpty">
            <span class="material-icons">mic_none</span>
            <p>Aucune note pour l'instant.<br>üéôÔ∏è <strong>Enregistrer</strong> = audio seul<br>‚úçÔ∏è <strong>Dicter</strong> = texte par la voix</p>
        </div>
    </main>

    <button class="fab-text" id="fabText" title="Nouvelle note √©crite"><span class="material-icons">edit_note</span></button>

    <!-- Text note modal -->
    <div class="modal-overlay" id="textModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Nouvelle note</div>
                <button class="modal-close" id="modalClose"><span class="material-icons">close</span></button>
            </div>
            <textarea class="modal-textarea" id="modalTextarea" placeholder="√âcrivez votre note ici..."></textarea>
            <button class="modal-save-btn" id="modalSave"><span class="material-icons">save</span> Enregistrer</button>
        </div>
    </div>

    <!-- Edit note modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Modifier la note</div>
                <button class="modal-close" id="editModalClose"><span class="material-icons">close</span></button>
            </div>
            <textarea class="modal-textarea" id="editTextarea" placeholder="Modifier le texte..."></textarea>
            <button class="modal-save-btn" id="editSave"><span class="material-icons">save</span> Sauvegarder</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    // ===================================================================
    // DATABASE
    // ===================================================================
    class NotesDB {
        constructor() { this.dbName = 'actuetmedia_notes'; this.dbVersion = 1; this.db = null; }
        async init() {
            return new Promise((res, rej) => {
                const r = indexedDB.open(this.dbName, this.dbVersion);
                r.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains('notes')) db.createObjectStore('notes', { keyPath: 'id' }).createIndex('date', 'date'); };
                r.onsuccess = e => { this.db = e.target.result; res(); };
                r.onerror = () => rej(r.error);
            });
        }
        async save(note) { return new Promise((res, rej) => { const tx = this.db.transaction('notes', 'readwrite'); tx.objectStore('notes').put(note); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); }
        async get(id) { return new Promise((res, rej) => { const r = this.db.transaction('notes', 'readonly').objectStore('notes').get(id); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
        async getAll() { return new Promise((res, rej) => { const r = this.db.transaction('notes', 'readonly').objectStore('notes').getAll(); r.onsuccess = () => res(r.result.sort((a, b) => b.date - a.date)); r.onerror = () => rej(r.error); }); }
        async delete(id) { return new Promise((res, rej) => { const tx = this.db.transaction('notes', 'readwrite'); tx.objectStore('notes').delete(id); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); }
        async deleteAll() { return new Promise((res, rej) => { const tx = this.db.transaction('notes', 'readwrite'); tx.objectStore('notes').clear(); tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error); }); }
    }

    // ===================================================================
    // APP STATE
    // ===================================================================
    const db = new NotesDB();
    let currentMode = 'audio'; // 'audio' ou 'dictation'
    let isRecording = false;
    let recordStartTime = 0;
    let timerInterval = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recognition = null;
    let finalTranscript = '';
    let interimTranscript = '';
    let savedTranscript = ''; // Texte accumul√© entre les relances
    let currentAudio = null;
    let currentPlayBtn = null;
    let editingNoteId = null;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const speechSupported = !!SpeechRecognition;

    const $ = id => document.getElementById(id);
    const recorderZone = $('recorderZone');
    const recordTimer = $('recordTimer');
    const recordLabel = $('recordLabel');
    const speechStatus = $('speechStatus');
    const liveTranscription = $('liveTranscription');
    const liveText = $('liveText');
    const notesList = $('notesList');
    const notesEmpty = $('notesEmpty');
    const notesCount = $('notesCount');
    const vizBars = document.querySelectorAll('.viz-bar');

    // ===================================================================
    // THEME
    // ===================================================================
    function initTheme() {
        // Synchroniser avec le th√®me du site parent si disponible
        const saved = localStorage.getItem('notes_theme');
        const siteTheme = document.cookie.match(/theme=(\w+)/)?.[1];
        const parentTheme = localStorage.getItem('theme');
        const theme = saved || parentTheme || siteTheme || 'dark';
        setTheme(theme);
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('notes_theme', theme);
        const icon = $('themeToggle').querySelector('.material-icons');
        icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
        // Mettre √† jour meta theme-color
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.content = theme === 'dark' ? '#0a0a14' : '#f5f5f7';
    }

    $('themeToggle').addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        setTheme(current === 'dark' ? 'light' : 'dark');
    });

    // ===================================================================
    // MODE SELECTOR
    // ===================================================================
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (isRecording) return; // Pas changer de mode en cours d'enregistrement
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;

            if (currentMode === 'audio') {
                recordLabel.textContent = 'Appuyez pour enregistrer';
            } else {
                recordLabel.textContent = 'Appuyez pour dicter';
            }
        });
    });

    // ===================================================================
    // INIT
    // ===================================================================
    async function init() {
        await db.init();
        initTheme();
        if (!speechSupported) {
            $('browserWarning').style.display = 'block';
            $('modeDictation').style.opacity = '0.4';
            $('modeDictation').style.pointerEvents = 'none';
        }
        renderNotes();
    }

    // ===================================================================
    // RECORDING
    // ===================================================================
    $('recordBtn').addEventListener('click', () => isRecording ? stopRecording() : startRecording());

    async function startRecording() {
        try {
            finalTranscript = '';
            interimTranscript = '';
            savedTranscript = '';
            isRecording = true;
            recordStartTime = Date.now();

            if (currentMode === 'audio') {
                // MODE AUDIO : MediaRecorder seul, pas de transcription
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(t => t.stop());
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    saveVoiceNote(blob);
                };
                mediaRecorder.start();
                recordLabel.textContent = 'Appuyez pour arr√™ter';

            } else {
                // MODE DICTATION : SpeechRecognition seul, pas d'audio
                startSpeechRecognition();
                recordLabel.textContent = 'Appuyez pour arr√™ter';
            }

            recorderZone.classList.add('recording');
            startTimer();
            startVizAnimation();

        } catch (err) {
            console.error('Erreur:', err);
            isRecording = false;
            showToast('‚ö†Ô∏è Acc√®s au micro refus√©');
        }
    }

    function stopRecording() {
        isRecording = false;
        recorderZone.classList.remove('recording');
        stopTimer();
        stopVizAnimation();

        if (currentMode === 'audio') {
            recordLabel.textContent = 'Appuyez pour enregistrer';
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        } else {
            recordLabel.textContent = 'Appuyez pour dicter';
            if (recognition) { try { recognition.abort(); } catch(e) {} recognition = null; }
            liveTranscription.classList.remove('active');
            speechStatus.style.display = 'none';
            // Sauvegarder la dict√©e comme note texte
            const text = (savedTranscript + interimTranscript).trim();
            if (text) {
                saveDictationNote(text);
            } else {
                showToast('‚ö†Ô∏è Aucun texte d√©tect√©');
            }
        }
    }

    // ===================================================================
    // SPEECH RECOGNITION (mode dict√©e uniquement)
    // ===================================================================
    function startSpeechRecognition() {
        speechStatus.style.display = 'block';
        speechStatus.textContent = '‚è≥ Initialisation...';
        speechStatus.style.color = 'var(--text-muted)';

        try {
            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                speechStatus.textContent = 'üé§ Parlez, je transcris...';
                speechStatus.style.color = 'var(--accent-green)';
                liveTranscription.classList.add('active');
                liveText.innerHTML = '<span class="interim">En √©coute...</span>';
            };

            recognition.onresult = (e) => {
                // V5 : approche ultra-simple
                // On ignore TOUT sauf le dernier r√©sultat
                const lastIndex = e.results.length - 1;
                const result = e.results[lastIndex];
                const transcript = result[0].transcript;

                if (result.isFinal) {
                    savedTranscript += transcript + ' ';
                    interimTranscript = '';
                } else {
                    // √âcraser (pas ajouter) l'interim
                    interimTranscript = transcript;
                }

                // Affichage : texte confirm√© + interim en cours
                const display = savedTranscript + interimTranscript;
                liveText.textContent = display;
                liveText.scrollTop = liveText.scrollHeight;
                
                // Debug visible sous le bouton
                speechStatus.textContent = 'üé§ v5 | finals:' + savedTranscript.split(' ').length + ' | last:"' + transcript.substring(0, 30) + '"';
            };

            recognition.onerror = (e) => {
                const msgs = { 'not-allowed': '‚ùå Micro refus√©', 'network': '‚ùå Internet requis', 'no-speech': 'üé§ Parlez...', 'audio-capture': '‚ùå Micro indisponible' };
                if (msgs[e.error]) { speechStatus.textContent = msgs[e.error]; speechStatus.style.color = e.error === 'no-speech' ? 'var(--accent-amber)' : 'var(--accent-red)'; }
            };

            recognition.onend = () => {
                if (isRecording && currentMode === 'dictation') {
                    // Ajouter l'interim en cours avant la relance
                    if (interimTranscript) {
                        savedTranscript += interimTranscript + ' ';
                        interimTranscript = '';
                    }
                    setTimeout(() => {
                        if (!isRecording) return;
                        try { recognition.start(); } catch(e) { speechStatus.textContent = '‚ö†Ô∏è Interrompu'; }
                    }, 300);
                }
            };

            recognition.start();
        } catch (e) {
            speechStatus.textContent = '‚ùå Non disponible';
            speechStatus.style.color = 'var(--accent-red)';
        }
    }

    // ===================================================================
    // VIZ ANIMATION (CSS-based, works for both modes)
    // ===================================================================
    let vizAnimInterval;
    function startVizAnimation() {
        vizAnimInterval = setInterval(() => {
            vizBars.forEach(bar => {
                const h = Math.random() * 45 + 8;
                bar.style.height = h + 'px';
            });
        }, 120);
    }
    function stopVizAnimation() {
        clearInterval(vizAnimInterval);
        vizBars.forEach(bar => bar.style.height = '8px');
    }

    // ===================================================================
    // TIMER
    // ===================================================================
    function startTimer() {
        recordTimer.textContent = '00:00';
        timerInterval = setInterval(() => {
            const s = Math.floor((Date.now() - recordStartTime) / 1000);
            recordTimer.textContent = String(Math.floor(s / 60)).padStart(2, '0') + ':' + String(s % 60).padStart(2, '0');
        }, 200);
    }
    function stopTimer() { clearInterval(timerInterval); }

    // ===================================================================
    // SAVE
    // ===================================================================
    async function saveVoiceNote(audioBlob) {
        const duration = Math.floor((Date.now() - recordStartTime) / 1000);
        const reader = new FileReader();
        reader.onload = async () => {
            await db.save({
                id: 'note_' + Date.now(), type: 'voice',
                text: '(Note audio)', audioData: reader.result,
                duration, date: Date.now()
            });
            renderNotes();
            showToast('üéôÔ∏è Audio enregistr√©');
            recordTimer.textContent = '00:00';
        };
        reader.readAsDataURL(audioBlob);
    }

    async function saveDictationNote(text) {
        await db.save({
            id: 'note_' + Date.now(), type: 'dictation',
            text, date: Date.now()
        });
        renderNotes();
        showToast('‚úçÔ∏è Dict√©e enregistr√©e');
        finalTranscript = ''; interimTranscript = ''; savedTranscript = '';
        liveText.innerHTML = ''; recordTimer.textContent = '00:00';
    }

    // Save text note from modal
    $('modalSave').addEventListener('click', async () => {
        const text = $('modalTextarea').value.trim();
        if (!text) return;
        await db.save({ id: 'note_' + Date.now(), type: 'text', text, date: Date.now() });
        renderNotes(); showToast('üìù Note enregistr√©e');
        $('modalTextarea').value = '';
        $('textModal').classList.remove('active');
    });

    // ===================================================================
    // EDIT NOTE
    // ===================================================================
    async function editNote(id) {
        const note = await db.get(id);
        if (!note) return;
        editingNoteId = id;
        $('editTextarea').value = note.text === '(Note audio)' ? '' : note.text;
        $('editModal').classList.add('active');
        $('editTextarea').focus();
    }

    $('editSave').addEventListener('click', async () => {
        if (!editingNoteId) return;
        const note = await db.get(editingNoteId);
        if (!note) return;
        note.text = $('editTextarea').value.trim() || '(Note audio)';
        await db.save(note);
        renderNotes(); showToast('‚úÖ Note modifi√©e');
        $('editModal').classList.remove('active');
        editingNoteId = null;
    });

    $('editModalClose').addEventListener('click', () => { $('editModal').classList.remove('active'); editingNoteId = null; });
    $('editModal').addEventListener('click', e => { if (e.target.id === 'editModal') { $('editModal').classList.remove('active'); editingNoteId = null; } });

    // ===================================================================
    // RENDER
    // ===================================================================
    async function renderNotes(filter = '') {
        let notes = await db.getAll();
        if (filter) { const q = filter.toLowerCase(); notes = notes.filter(n => n.text.toLowerCase().includes(q)); }

        notesCount.textContent = notes.length;
        notesEmpty.style.display = notes.length ? 'none' : 'block';

        notesList.innerHTML = notes.map(note => {
            const dateStr = formatDate(note.date);
            const badges = {
                voice: { icon: 'mic', label: 'Audio', cls: 'voice' },
                dictation: { icon: 'record_voice_over', label: 'Dict√©e', cls: 'dictation' },
                text: { icon: 'edit_note', label: 'Texte', cls: 'text' }
            };
            const b = badges[note.type] || badges.text;

            let audioHTML = '';
            if (note.type === 'voice' && note.audioData) {
                audioHTML = `
                    <div class="note-audio-player">
                        <button class="note-play-btn" onclick="playAudio('${note.id}', this)" data-audio="${note.audioData}">
                            <span class="material-icons">play_arrow</span>
                        </button>
                        <div class="note-audio-info">
                            <div class="note-audio-duration">${formatDuration(note.duration)}</div>
                            <div class="note-audio-progress"><div class="note-audio-progress-bar" id="prog_${note.id}"></div></div>
                        </div>
                    </div>`;
            }

            const txt = note.text;

            return `
                <div class="note-card" id="card_${note.id}">
                    <div class="note-card-header">
                        <span class="note-type-badge ${b.cls}"><span class="material-icons">${b.icon}</span> ${b.label}</span>
                        <span class="note-date">${dateStr}</span>
                    </div>
                    ${audioHTML}
                    <div class="note-content">${escapeHTML(txt)}</div>
                    <div class="note-actions">
                        <button class="note-action-btn" onclick="editNote('${note.id}')"><span class="material-icons">edit</span> √âditer</button>
                        <button class="note-action-btn" onclick="copyNote('${note.id}')"><span class="material-icons">content_copy</span> Copier</button>
                        <button class="note-action-btn" onclick="shareNote('${note.id}')"><span class="material-icons">share</span></button>
                        <button class="note-action-btn delete" onclick="deleteNote('${note.id}')"><span class="material-icons">delete</span></button>
                    </div>
                </div>`;
        }).join('');
    }

    // ===================================================================
    // PLAYBACK
    // ===================================================================
    function playAudio(noteId, btn) {
        const src = btn.dataset.audio;
        const prog = $('prog_' + noteId);

        if (currentPlayBtn === btn && currentAudio) {
            if (!currentAudio.paused) { currentAudio.pause(); btn.innerHTML = '<span class="material-icons">play_arrow</span>'; return; }
            else { currentAudio.play(); btn.innerHTML = '<span class="material-icons">pause</span>'; return; }
        }

        if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; if (currentPlayBtn) currentPlayBtn.innerHTML = '<span class="material-icons">play_arrow</span>'; }

        const audio = new Audio(src);
        currentAudio = audio; currentPlayBtn = btn;
        btn.innerHTML = '<span class="material-icons">pause</span>';
        audio.ontimeupdate = () => { if (audio.duration && prog) prog.style.width = (audio.currentTime / audio.duration * 100) + '%'; };
        audio.onended = () => { btn.innerHTML = '<span class="material-icons">play_arrow</span>'; if (prog) prog.style.width = '0%'; currentAudio = null; currentPlayBtn = null; };
        audio.play();
    }

    // ===================================================================
    // ACTIONS
    // ===================================================================
    async function copyNote(id) {
        const n = await db.get(id);
        if (n) { await navigator.clipboard.writeText(n.text); showToast('üìã Copi√©'); }
    }
    async function shareNote(id) {
        const n = await db.get(id);
        if (n && navigator.share) { try { await navigator.share({ text: n.text }); } catch(e) {} }
        else if (n) { await navigator.clipboard.writeText(n.text); showToast('üìã Copi√©'); }
    }
    async function deleteNote(id) {
        if (!confirm('Supprimer cette note ?')) return;
        if (currentAudio) { currentAudio.pause(); currentAudio = null; currentPlayBtn = null; }
        await db.delete(id);
        const card = $('card_' + id);
        if (card) { card.style.opacity = '0'; card.style.transform = 'translateX(100px)'; card.style.transition = 'all 0.3s'; }
        setTimeout(() => renderNotes(), 300);
        showToast('üóëÔ∏è Supprim√©e');
    }

    $('deleteAllBtn').addEventListener('click', async () => {
        const notes = await db.getAll();
        if (!notes.length) return;
        if (!confirm(`Supprimer les ${notes.length} note(s) ?`)) return;
        if (!confirm('Irr√©versible. Confirmer ?')) return;
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        await db.deleteAll(); renderNotes(); showToast('üóëÔ∏è Tout supprim√©');
    });

    // ===================================================================
    // EXPORT / IMPORT
    // ===================================================================
    $('exportBtn').addEventListener('click', async () => {
        const notes = await db.getAll();
        if (!notes.length) { showToast('‚ö†Ô∏è Aucune note'); return; }
        const blob = new Blob([JSON.stringify({ app: 'ActuetMedia Notes', v: 1, date: new Date().toISOString(), notes })], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `notes-vocales-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        showToast(`üì¶ ${notes.length} note(s) export√©e(s)`);
    });

    $('importBtn').addEventListener('click', () => $('importFile').click());

    $('importFile').addEventListener('change', async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try {
            const data = JSON.parse(await file.text());
            if (!data.notes?.length) { showToast('‚ö†Ô∏è Invalide'); return; }
            const existing = new Set((await db.getAll()).map(n => n.id));
            let ok = 0, skip = 0;
            for (const n of data.notes) {
                if (!n.id || !n.type || !n.text) continue;
                if (existing.has(n.id)) { skip++; continue; }
                await db.save(n); ok++;
            }
            renderNotes();
            showToast(`üì• ${ok} import√©e(s)` + (skip ? ` (${skip} doublon(s))` : ''));
        } catch(err) { showToast('‚ö†Ô∏è Erreur import'); }
        e.target.value = '';
    });

    // ===================================================================
    // FONT SIZE
    // ===================================================================
    const fontSlider = $('fontSizeSlider');
    const savedFontSize = localStorage.getItem('notes_font_size');
    if (savedFontSize) {
        fontSlider.value = savedFontSize;
        document.documentElement.style.setProperty('--note-font-size', savedFontSize + 'px');
    }
    fontSlider.addEventListener('input', (e) => {
        const size = e.target.value;
        document.documentElement.style.setProperty('--note-font-size', size + 'px');
        localStorage.setItem('notes_font_size', size);
    });

    // ===================================================================
    // MODALS
    // ===================================================================
    $('fabText').addEventListener('click', () => { $('textModal').classList.add('active'); $('modalTextarea').focus(); });
    $('modalClose').addEventListener('click', () => $('textModal').classList.remove('active'));
    $('textModal').addEventListener('click', e => { if (e.target.id === 'textModal') $('textModal').classList.remove('active'); });

    // ===================================================================
    // SEARCH
    // ===================================================================
    $('searchToggle').addEventListener('click', () => {
        const bar = $('searchBar');
        bar.classList.toggle('active');
        if (bar.classList.contains('active')) $('searchInput').focus();
        else { $('searchInput').value = ''; renderNotes(); }
    });
    $('searchInput').addEventListener('input', e => renderNotes(e.target.value));

    // ===================================================================
    // HELPERS
    // ===================================================================
    function formatDate(ts) {
        const d = new Date(ts), now = new Date(), diff = now - d;
        if (diff < 60000) return '√Ä l\'instant';
        if (diff < 3600000) return `Il y a ${Math.floor(diff / 60000)} min`;
        if (diff < 86400000 && d.getDate() === now.getDate())
            return 'Aujourd\'hui ' + d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    function formatDuration(s) { return String(Math.floor(s / 60)).padStart(2, '0') + ':' + String(s % 60).padStart(2, '0'); }
    function escapeHTML(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function showToast(msg) { const t = $('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

    init();
    </script>
</body>
</html>