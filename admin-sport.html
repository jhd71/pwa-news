<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ Admin Sport - Actu & M√©dia</title>
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --bg: #0f172a;
            --bg-card: rgba(255, 255, 255, 0.08);
            --bg-elevated: rgba(255, 255, 255, 0.12);
            --border: rgba(255, 255, 255, 0.12);
            --text: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="light"] {
            --bg: #f1f5f9;
            --bg-card: #ffffff;
            --bg-elevated: #f8fafc;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 1rem;
        }
        
        .header-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.3px;
        }
        
        .header-title .amp {
            color: #f59e0b;
            font-weight: 400;
            font-style: italic;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            color: var(--primary-light);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .header-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .header-btn .material-icons { font-size: 1.15rem; }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }
        
        .btn-primary:hover { transform: translateY(-1px); }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }
        
        .btn-back {
            background: var(--bg-elevated);
            color: var(--text);
            border: 1px solid var(--border);
            text-decoration: none;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select {
            padding: 0.6rem 0.8rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-light);
        }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }
        
        .checkbox-row input[type="checkbox"] {
            width: 1.1rem;
            height: 1.1rem;
        }
        
        .checkbox-row label {
            font-size: 0.85rem;
            text-transform: none;
            color: var(--text);
        }
        
        .status-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-bar div {
            width: 100%;
        }
        
        .status-bar.success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }
        
        .status-bar.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }
        
        .status-bar.info {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--primary-light);
        }
        
        .preview-section {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .preview-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }
        
        .preview-match {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 0.5rem;
        }
        
        .preview-team {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .preview-score {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--primary-light);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-divider {
            height: 1px;
            background: var(--border);
            margin: 1rem 0;
        }
        
        .last-update {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.5rem;
        }

        /* Live preview du prochain match */
        .live-preview {
            background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.08));
            border: 1px solid rgba(99,102,241,0.25);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.75rem;
            text-align: center;
        }
        .live-preview-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }
        .live-preview-match {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .live-preview-vs {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        .live-preview-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.4rem;
        }

        /* Indicateur modifications non sauvegard√©es */
        .unsaved-dot {
            width: 8px;
            height: 8px;
            background: var(--warning);
            border-radius: 50%;
            display: none;
            animation: pulse 1.5s ease infinite;
        }
        .unsaved-dot.visible { display: inline-block; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }
            
            .header {
                flex-direction: column;
                gap: 0.75rem;
                padding: 0.75rem;
                border-radius: 12px;
            }
            
            .header-title {
                font-size: 1.1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.4rem;
            }
            
            .header-btn {
                width: 36px;
                height: 36px;
            }

            .header-btn .material-icons { font-size: 1rem; }
            
            .card {
                padding: 0.85rem;
                border-radius: 12px;
                margin-bottom: 0.75rem;
            }
            
            .card-title {
                font-size: 0.9rem;
                margin-bottom: 0.75rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 0.6rem;
            }
            
            input, select {
                padding: 0.55rem 0.7rem;
                font-size: 0.85rem;
                border-radius: 8px;
            }
            
            label {
                font-size: 0.7rem;
            }
            
            .form-row {
                flex-wrap: wrap;
                gap: 0.4rem;
            }
            
            .form-row .form-group {
                flex: 1 1 calc(33.33% - 0.3rem);
                min-width: 60px;
            }
            
            .form-row select {
                font-size: 0.75rem;
                padding: 0.5rem 0.3rem;
            }
            
            .status-bar {
                font-size: 0.8rem;
                padding: 0.6rem 0.75rem;
                border-radius: 8px;
                flex-wrap: wrap;
                word-break: break-word;
            }
            
            .status-bar div {
                width: 100%;
            }
            
            .checkbox-row label {
                font-size: 0.8rem;
            }
        }

        /* ====== LOGIN ====== */
        .login-overlay {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; padding: 20px;
        }
        .login-overlay.hidden { display: none; }
        .login-box { width: 100%; max-width: 380px; text-align: center; }
        .login-avatar {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            border-radius: 24px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        .login-avatar .material-icons { font-size: 40px; color: white; }
        .login-box h1 { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 900; margin-bottom: 6px; color: var(--text); }
        .login-box p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 32px; }
        .login-field { position: relative; margin-bottom: 16px; }
        .login-field .material-icons {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            color: var(--text-secondary); font-size: 20px;
        }
        .login-field input {
            width: 100%; padding: 16px 16px 16px 52px;
            background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 14px; color: var(--text); font-size: 1rem; font-family: inherit; outline: none;
        }
        .login-field input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
        .login-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border: none; border-radius: 14px; color: white;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(99,102,241,0.4); }
        .login-error {
            display: none; background: rgba(239,68,68,0.15); color: var(--danger);
            padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 0.85rem;
        }
        .admin-content { display: none; }
        .admin-content.show { display: block; }
    </style>
</head>
<body>

    <!-- ====== √âCRAN DE CONNEXION ====== -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <div class="login-avatar">
                <span class="material-icons">sports_soccer</span>
            </div>
            <h1>Admin Sport</h1>
            <p>Actu <span style="color:#f59e0b;font-style:italic;">&</span> M√©dia ‚Äî FC Montceau Bourgogne</p>
            <form id="loginForm">
                <div class="login-field">
                    <span class="material-icons">key</span>
                    <input type="password" id="loginPassword" placeholder="Mot de passe" autocomplete="current-password">
                </div>
                <div class="login-error" id="loginError">
                    <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">error</span>
                    Mot de passe incorrect
                </div>
                <button type="submit" class="login-btn">
                    <span class="material-icons">login</span>
                    Se connecter
                </button>
            </form>
        </div>
    </div>

    <!-- ====== CONTENU ADMIN (cach√© par d√©faut) ====== -->
    <div class="admin-content" id="adminContent">

    <div class="header">
        <div class="header-title">‚öΩ Actu <span class="amp">&</span> M√©dia ‚Äî Sport</div>
        <div class="header-actions">
            <span class="unsaved-dot" id="unsavedDot" title="Modifications non sauvegard√©es"></span>
            <button class="header-btn" onclick="toggleTheme()" title="Changer le th√®me">
                <span class="material-icons" id="themeIcon">light_mode</span>
            </button>
            <button class="header-btn" onclick="runScraper()" title="Scraper automatique">
                <span class="material-icons">sync</span>
            </button>
            <button class="header-btn" onclick="saveSportData()" title="Sauvegarder" style="background:rgba(16,185,129,0.2);border-color:rgba(16,185,129,0.4);color:var(--success);">
                <span class="material-icons">save</span>
            </button>
            <a href="/admin.html" class="header-btn" title="Admin principal">
                <span class="material-icons">admin_panel_settings</span>
            </a>
            <a href="/index.html" class="header-btn" title="Accueil">
                <span class="material-icons">home</span>
            </a>
        </div>
    </div>

    <!-- Scraper status -->
    <div id="scraperStatus" style="display:none;" class="status-bar info">
        <span class="material-icons" style="font-size:1rem;animation:spin 1s linear infinite;">sync</span>
        Scraping en cours...
    </div>
    <style>@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }</style>

    <div id="statusBar" style="display:none;"></div>

    <!-- DERNIER MATCH -->
    <div class="card">
        <div class="card-title">üìä Dernier match jou√©</div>
        <div class="form-grid">
            <div class="form-group">
                <label>Date du match</label>
                <input type="date" id="lastMatchDate">
            </div>
            <div class="form-group">
                <label>Journ√©e</label>
                <input type="text" id="lastMatchDay" placeholder="Journ√©e 10">
            </div>
            <div class="form-group">
                <label>√âquipe domicile</label>
                <input type="text" id="lastHomeTeam" placeholder="FC Montceau">
            </div>
            <div class="form-group">
                <label>Score domicile</label>
                <input type="number" id="lastHomeScore" min="0" max="20">
            </div>
            <div class="form-group">
                <label>√âquipe ext√©rieur</label>
                <input type="text" id="lastAwayTeam" placeholder="Adversaire">
            </div>
            <div class="form-group">
                <label>Score ext√©rieur</label>
                <input type="number" id="lastAwayScore" min="0" max="20">
            </div>
            <div class="form-group full-width">
                <div class="checkbox-row">
                    <input type="checkbox" id="lastIsHome" checked>
                    <label for="lastIsHome">FCMB joue √† domicile</label>
                </div>
            </div>
        </div>
    </div>

    <!-- PROCHAIN MATCH -->
    <div class="card">
        <div class="card-title">üìÖ Prochain match</div>
        <div class="form-grid">
            <div class="form-group">
                <label>Date du match</label>
                <input type="date" id="nextMatchDate">
            </div>
            <div class="form-group">
                <label>Heure</label>
                <input type="time" id="nextMatchTime" value="18:00">
            </div>
            <div class="form-group">
                <label>Journ√©e</label>
                <input type="text" id="nextMatchDay" placeholder="Journ√©e 11">
            </div>
            <div class="form-group">
                <label>Adversaire</label>
                <input type="text" id="nextAwayTeam" placeholder="Nom de l'adversaire">
            </div>
            <div class="form-group full-width">
                <div class="checkbox-row">
                    <input type="checkbox" id="nextIsHome" checked>
                    <label for="nextIsHome">FCMB joue √† domicile</label>
                </div>
            </div>
        </div>
        <!-- Aper√ßu live du prochain match -->
        <div class="live-preview" id="nextMatchPreview">
            <div class="live-preview-label">Aper√ßu</div>
            <div class="live-preview-match">
                <span id="previewHome">FC Montceau</span>
                <span class="live-preview-vs">vs</span>
                <span id="previewAway">‚Äî</span>
            </div>
            <div class="live-preview-meta" id="previewMeta"></div>
        </div>
    </div>

    <!-- CLASSEMENT -->
    <div class="card">
        <div class="card-title">üèÜ Classement</div>
        <div class="form-grid">
            <div class="form-group">
                <label>Position</label>
                <input type="number" id="standingPosition" min="1" max="20">
            </div>
            <div class="form-group">
                <label>Points</label>
                <input type="number" id="standingPoints" min="0">
            </div>
            <div class="form-group">
                <label>Matchs jou√©s</label>
                <input type="number" id="standingPlayed" min="0">
            </div>
            <div class="form-group">
                <label>Victoires</label>
                <input type="number" id="standingWon" min="0">
            </div>
            <div class="form-group">
                <label>Nuls</label>
                <input type="number" id="standingDrawn" min="0">
            </div>
            <div class="form-group">
                <label>D√©faites</label>
                <input type="number" id="standingLost" min="0">
            </div>
            <div class="form-group">
                <label>Buts pour</label>
                <input type="number" id="standingGoalsFor" min="0">
            </div>
            <div class="form-group">
                <label>Buts contre</label>
                <input type="number" id="standingGoalsAgainst" min="0">
            </div>
        </div>
    </div>

    <!-- FORME -->
    <div class="card">
        <div class="card-title">üìà Forme (5 derniers matchs)</div>
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
            Du plus ancien au plus r√©cent. V = Victoire, N = Nul, D = D√©faite
        </p>
        <div class="form-row">
            <div class="form-group">
                <label>Match 1</label>
                <select id="form1"><option value="V">V - Victoire</option><option value="N">N - Nul</option><option value="D">D - D√©faite</option></select>
            </div>
            <div class="form-group">
                <label>Match 2</label>
                <select id="form2"><option value="V">V - Victoire</option><option value="N">N - Nul</option><option value="D">D - D√©faite</option></select>
            </div>
            <div class="form-group">
                <label>Match 3</label>
                <select id="form3"><option value="V">V - Victoire</option><option value="N">N - Nul</option><option value="D">D - D√©faite</option></select>
            </div>
            <div class="form-group">
                <label>Match 4</label>
                <select id="form4"><option value="V">V - Victoire</option><option value="N">N - Nul</option><option value="D">D - D√©faite</option></select>
            </div>
            <div class="form-group">
                <label>Match 5</label>
                <select id="form5"><option value="V">V - Victoire</option><option value="N">N - Nul</option><option value="D">D - D√©faite</option></select>
            </div>
        </div>
    </div>

    <div class="last-update" id="lastUpdate"></div>

    </div><!-- fin admin-content -->

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ====== AUTHENTIFICATION ======
        const ADMIN_PASSWORD_HASH = 'cbf9b2262208b861889d115988760153fab34a144a926b0ab394ef8ecbaf4d70';
        const SESSION_KEY = 'adminSportAuth';

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function checkSession() {
            // V√©rifier session sport OU session hub (m√™me mot de passe)
            const saved = localStorage.getItem(SESSION_KEY);
            const hubSaved = localStorage.getItem('adminHubAuth');
            if (saved === ADMIN_PASSWORD_HASH || hubSaved === ADMIN_PASSWORD_HASH) {
                showAdmin();
            }
        }

        function showAdmin() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('adminContent').classList.add('show');
            loadExistingData();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            if (!password) { errorEl.style.display = 'block'; return; }
            const hash = await hashPassword(password);
            if (hash === ADMIN_PASSWORD_HASH) {
                localStorage.setItem(SESSION_KEY, hash);
                showAdmin();
            } else {
                errorEl.style.display = 'block';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        });

        const SUPABASE_URL = 'https://ekjgfiyhkythqcnmhzea.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVramdmaXloa3l0aHFjbm1oemVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzYxNDIsImV4cCI6MjA1ODI1MjE0Mn0.V0j_drb6GiTojgwxC6ydjnyJDRRT9lUbSc1E7bFE2Z4';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentDataId = null;

        // Charger les donn√©es existantes
        async function loadExistingData() {
            try {
                const { data, error } = await supabaseClient
                    .from('sport_data')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(1)
                    .single();

                if (error || !data) {
                    showStatus('Aucune donn√©e existante. Remplissez le formulaire.', 'info');
                    return;
                }

                currentDataId = data.id;

                // Remplir le formulaire
                // Dernier match
                if (data.last_match_date) document.getElementById('lastMatchDate').value = data.last_match_date;
                if (data.last_match_matchday) document.getElementById('lastMatchDay').value = data.last_match_matchday;
                if (data.last_match_home_team) document.getElementById('lastHomeTeam').value = data.last_match_home_team;
                if (data.last_match_away_team) document.getElementById('lastAwayTeam').value = data.last_match_away_team;
                if (data.last_match_home_score !== null) document.getElementById('lastHomeScore').value = data.last_match_home_score;
                if (data.last_match_away_score !== null) document.getElementById('lastAwayScore').value = data.last_match_away_score;
                document.getElementById('lastIsHome').checked = data.last_match_is_home !== false;

                // Prochain match
                if (data.next_match_date) document.getElementById('nextMatchDate').value = data.next_match_date;
                if (data.next_match_time) document.getElementById('nextMatchTime').value = data.next_match_time;
                if (data.next_match_matchday) document.getElementById('nextMatchDay').value = data.next_match_matchday;
                
                // D√©terminer l'adversaire du prochain match
                if (data.next_match_is_home) {
                    document.getElementById('nextAwayTeam').value = data.next_match_away_team || '';
                } else {
                    document.getElementById('nextAwayTeam').value = data.next_match_home_team || '';
                }
                document.getElementById('nextIsHome').checked = data.next_match_is_home !== false;

                // Classement
                if (data.standing_position) document.getElementById('standingPosition').value = data.standing_position;
                if (data.standing_points !== null) document.getElementById('standingPoints').value = data.standing_points;
                if (data.standing_played !== null) document.getElementById('standingPlayed').value = data.standing_played;
                if (data.standing_won !== null) document.getElementById('standingWon').value = data.standing_won;
                if (data.standing_drawn !== null) document.getElementById('standingDrawn').value = data.standing_drawn;
                if (data.standing_lost !== null) document.getElementById('standingLost').value = data.standing_lost;
                if (data.standing_goals_for !== null) document.getElementById('standingGoalsFor').value = data.standing_goals_for;
                if (data.standing_goals_against !== null) document.getElementById('standingGoalsAgainst').value = data.standing_goals_against;

                // Forme
                if (data.form) {
                    const formArr = data.form.split(',').map(f => f.trim());
                    for (let i = 0; i < 5; i++) {
                        const sel = document.getElementById('form' + (i + 1));
                        if (sel && formArr[i]) sel.value = formArr[i];
                    }
                }

                // Date de mise √† jour
                if (data.updated_at) {
                    const d = new Date(data.updated_at);
                    document.getElementById('lastUpdate').textContent = 'Derni√®re mise √† jour : ' + d.toLocaleString('fr-FR');
                }

                showStatus('‚úÖ Donn√©es charg√©es', 'success');

            } catch (err) {
                console.error('Erreur chargement:', err);
                showStatus('Erreur de chargement: ' + err.message, 'error');
            }
        }

        // Sauvegarder
        async function saveSportData() {
            try {
                const isHome = document.getElementById('nextIsHome').checked;
                const adversaire = document.getElementById('nextAwayTeam').value.trim();

                const payload = {
                    // Dernier match
                    last_match_date: document.getElementById('lastMatchDate').value || null,
                    last_match_time: '18:00',
                    last_match_matchday: document.getElementById('lastMatchDay').value.trim() || null,
                    last_match_home_team: document.getElementById('lastHomeTeam').value.trim() || null,
                    last_match_away_team: document.getElementById('lastAwayTeam').value.trim() || null,
                    last_match_home_score: parseInt(document.getElementById('lastHomeScore').value) || 0,
                    last_match_away_score: parseInt(document.getElementById('lastAwayScore').value) || 0,
                    last_match_is_home: document.getElementById('lastIsHome').checked,

                    // Prochain match
                    next_match_date: document.getElementById('nextMatchDate').value || null,
                    next_match_time: document.getElementById('nextMatchTime').value || '18:00',
                    next_match_matchday: document.getElementById('nextMatchDay').value.trim() || null,
                    next_match_home_team: isHome ? 'FC Montceau' : adversaire,
                    next_match_away_team: isHome ? adversaire : 'FC Montceau',
                    next_match_is_home: isHome,

                    // Classement
                    standing_position: parseInt(document.getElementById('standingPosition').value) || null,
                    standing_points: parseInt(document.getElementById('standingPoints').value) || 0,
                    standing_played: parseInt(document.getElementById('standingPlayed').value) || 0,
                    standing_won: parseInt(document.getElementById('standingWon').value) || 0,
                    standing_drawn: parseInt(document.getElementById('standingDrawn').value) || 0,
                    standing_lost: parseInt(document.getElementById('standingLost').value) || 0,
                    standing_goals_for: parseInt(document.getElementById('standingGoalsFor').value) || 0,
                    standing_goals_against: parseInt(document.getElementById('standingGoalsAgainst').value) || 0,

                    // Forme
                    form: [
                        document.getElementById('form1').value,
                        document.getElementById('form2').value,
                        document.getElementById('form3').value,
                        document.getElementById('form4').value,
                        document.getElementById('form5').value
                    ].join(','),

                    updated_at: new Date().toISOString(),
                    updated_by: 'admin'
                };

                let result;
                if (currentDataId) {
                    // Mise √† jour
                    result = await supabaseClient
                        .from('sport_data')
                        .update(payload)
                        .eq('id', currentDataId);
                } else {
                    // Premi√®re insertion
                    result = await supabaseClient
                        .from('sport_data')
                        .insert(payload)
                        .select()
                        .single();
                    
                    if (result.data) currentDataId = result.data.id;
                }

                if (result.error) throw result.error;

                showStatus('‚úÖ Donn√©es sauvegard√©es avec succ√®s !', 'success');
                document.getElementById('lastUpdate').textContent = 'Derni√®re mise √† jour : ' + new Date().toLocaleString('fr-FR');

            } catch (err) {
                console.error('Erreur sauvegarde:', err);
                showStatus('‚ùå Erreur: ' + err.message, 'error');
            }
        }

        function showStatus(message, type) {
            const bar = document.getElementById('statusBar');
            bar.className = 'status-bar ' + type;
            bar.textContent = message;
            bar.style.display = 'flex';
            
            if (type === 'success') {
                setTimeout(() => { bar.style.display = 'none'; }, 4000);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            document.getElementById('loginPassword').focus();
            initTheme();
            initLivePreview();
            initUnsavedTracking();
        });

        // === TH√àME CLAIR/SOMBRE ===
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('admin_sport_theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) icon.textContent = theme === 'light' ? 'dark_mode' : 'light_mode';
        }

        function initTheme() {
            const saved = localStorage.getItem('admin_sport_theme') || localStorage.getItem('admin_theme') || 'dark';
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
            updateThemeIcon(saved);
        }

        // === APER√áU LIVE PROCHAIN MATCH ===
        function updateNextMatchPreview() {
            const isHome = document.getElementById('nextIsHome').checked;
            const adversaire = document.getElementById('nextAwayTeam').value.trim() || '‚Äî';
            const date = document.getElementById('nextMatchDate').value;
            const time = document.getElementById('nextMatchTime').value;
            const journee = document.getElementById('nextMatchDay').value.trim();

            document.getElementById('previewHome').textContent = isHome ? 'FC Montceau' : adversaire;
            document.getElementById('previewAway').textContent = isHome ? adversaire : 'FC Montceau';

            let meta = [];
            if (journee) meta.push(journee);
            if (date) {
                const d = new Date(date + 'T12:00:00');
                meta.push(d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }));
            }
            if (time) meta.push(time);
            meta.push(isHome ? 'üè† Domicile' : '‚úàÔ∏è Ext√©rieur');

            document.getElementById('previewMeta').textContent = meta.join(' ¬∑ ');
        }

        function initLivePreview() {
            ['nextAwayTeam', 'nextMatchDate', 'nextMatchTime', 'nextMatchDay'].forEach(function(id) {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateNextMatchPreview);
            });
            const nextIsHome = document.getElementById('nextIsHome');
            if (nextIsHome) nextIsHome.addEventListener('change', updateNextMatchPreview);
            // Mise √† jour initiale
            updateNextMatchPreview();
        }

        // === INDICATEUR MODIFICATIONS NON SAUVEGARD√âES ===
        let hasUnsavedChanges = false;

        function initUnsavedTracking() {
            const allInputs = document.querySelectorAll('.admin-content input, .admin-content select');
            allInputs.forEach(function(input) {
                input.addEventListener('change', function() {
                    hasUnsavedChanges = true;
                    const dot = document.getElementById('unsavedDot');
                    if (dot) dot.classList.add('visible');
                });
            });

            // Alerte si on quitte avec des modifications
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        // Marquer comme sauvegard√© apr√®s save
        const _origSaveSportData = saveSportData;
        saveSportData = async function() {
            await _origSaveSportData();
            hasUnsavedChanges = false;
            const dot = document.getElementById('unsavedDot');
            if (dot) dot.classList.remove('visible');
        };

        // Mettre √† jour le preview apr√®s chargement des donn√©es
        const _origLoadExistingData = loadExistingData;
        loadExistingData = async function() {
            await _origLoadExistingData();
            updateNextMatchPreview();
            hasUnsavedChanges = false;
            const dot = document.getElementById('unsavedDot');
            if (dot) dot.classList.remove('visible');
        };
        async function runScraper() {
            const statusEl = document.getElementById('scraperStatus');
            statusEl.style.display = 'flex';
            statusEl.className = 'status-bar info';
            statusEl.innerHTML = '<span class="material-icons" style="font-size:1rem;animation:spin 1s linear infinite;">sync</span> Scraping en cours...';

            try {
                const response = await fetch('/api/updateSport');
                const result = await response.json();

                if (result.success) {
                    statusEl.className = 'status-bar success';
                    const logsHtml = result.logs.map(l => '<div>' + l + '</div>').join('');
                    statusEl.innerHTML = '<div><strong>‚úÖ Scraping termin√© !</strong></div>' + logsHtml;

                    // Recharger les donn√©es dans le formulaire
                    setTimeout(loadExistingData, 1000);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (err) {
                statusEl.className = 'status-bar error';
                statusEl.innerHTML = '‚ùå Erreur scraper: ' + err.message;
            }
        }
    </script>
</body>
</html>